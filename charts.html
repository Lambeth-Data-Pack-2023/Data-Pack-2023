<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Category Template</title>
    <link rel="stylesheet" href="/Styles/colours.css" />
    <link rel="stylesheet" href="/Styles/images.css" />
    <link rel="stylesheet" href="/Styles/typography.css" />
    <link rel="stylesheet" href="/Styles/menu.css" />
    <link rel="stylesheet" href="/Styles/layout.css" />
    <link rel="stylesheet" href="/Styles/grid.css" />
    <link rel="stylesheet" href="/Styles/button.css" />
    <link rel="stylesheet" href="/Styles/header.css" />
    <link rel="icon" type="image/png" href="/Images/Lambeth-logo-favicon.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />

    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
      /* Add this CSS to your stylesheet */
      .line {
        transition: stroke-width 0.3s ease; /* Smooth transition for stroke-width change */
      }
      #lineGraph,
      #mapContainer,
      #gridChartContainer {
        height: 100%;
      }

      svg {
        height: 100%;
        width: 100%;
      }
      .tooltip {
        position: fixed;
        bottom: 9vh;
        left: 30vw;
        font-family: Verdana;
        color: #212c61;
      }
      .domain {
        stroke-width: 3px;
        color: #212c61;
      }
      .tick {
        font-weight: 400;
      }
      .legend text {
        font-family: Verdana;
        color: #212c61;
      }
      .grid-item-chart:hover {
        background-color: white;
      }
      g text {
        padding: 10px;
      }
      .ward {
        fill: #212c61;
        stroke: white;
        stroke-width: 0.5;
        transition: fill 0.3s ease-in-out;
      }

      .ward:hover {
        fill: orange;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- Page Header -->
    <header>
      <!-- The displayHeader() function outputs the header -->
    </header>

    <main class="flex">
      <div class="container-left">
        <div class="menu-container">
          <div class="menu-buttons">
            <button onclick="showPreviousMenu()">
              <i class="fa fa-arrow-left"></i>
            </button>
            <button onclick="showNextMenu()">
              <i class="fa fa-arrow-right"></i>
            </button>
          </div>
          <div id="menuItems"></div>
          <!-- Menu contents will be dynamically generated here -->
        </div>
      </div>
      <div class="container" style="border: none">
        <div>
          <!-- Dynamically display breadcrumbs -->
          <div id="breadcrumbs">
            <a href="/index.html">Home</a> /
            <span id="ambitionBreadcrumb"></span>
            <span id="categoryBreadcrumb"></span>
          </div>
          <!-- Dynamically display current page's chart name -->
          <h2 id="chartName">Childhood Vaccinations</h2>
        </div>

        <div id="root"></div>
      </div>
    </main>

    <script src="/Scripts/header.js"></script>
    <script src="/Scripts/chart-page-details.js"></script>

    <script type="text/babel">
      function createSVG(containerId) {
        const margin = { top: 20, right: 20, bottom: 30, left: 50 };
        const width = 600 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        // Remove previous SVG
        d3.select(`#${containerId} svg`).remove();

        // Create SVG container
        const svg = d3
          .select(`#${containerId}`)
          .append("svg")
          .attr("preserveAspectRatio", "xMinYMin meet")
          .attr(
            "viewBox",
            `0 0 ${width + margin.left + margin.right} ${
              height + margin.top + margin.bottom
            }`
          )
          .classed("svg-content", true)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        return svg;
      }
      function logAndExtractUniqueValues({
        jsonData,
        xKey,
        yKey,
        thirdKey,
        yLabel,
        mapType,
      }) {
        if (jsonData) {
          console.log("Json Data:", jsonData);
          console.log("X Key:", xKey);
          console.log("Y Key:", yKey);
          console.log("Third Key Variable:", thirdKey);
          console.log("Y Label:", yLabel);
          console.log("Map Type:", mapType);

          // Extracting unique values of the xKey from the jsonData
          const uniqueXValues = [
            ...new Set(jsonData.map((item) => item[xKey])),
          ];
          console.log("X Axis Values:", uniqueXValues);
          // Extracting unique values of the yKey from the jsonData
          const uniqueThirdValues = [
            ...new Set(jsonData.map((item) => item[thirdKey])),
          ];
          console.log("Third Variable Values:", uniqueThirdValues);
        }
      }
      function LineChart({ jsonData, xKey, yKey, thirdKey, yLabel, mapType }) {
        const mainLocations = ["London", "Lambeth", "England"];

        React.useEffect(() => {
          if (jsonData) {
            logAndExtractUniqueValues({
              jsonData,
              xKey,
              yKey,
              thirdKey,
              yLabel,
              mapType,
            });

            const margin = { top: 20, right: 20, bottom: 30, left: 50 };
            const width = 600 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            // Remove previous SVG
            d3.select(`#lineGraph svg`).remove();

            // Create SVG container
            const svg = d3
              .select(`#lineGraph`)
              .append("svg")
              .attr("preserveAspectRatio", "xMinYMin meet")
              .attr(
                "viewBox",
                `0 0 ${width + margin.left + margin.right} ${
                  height + margin.top + margin.bottom
                }`
              )
              .classed("svg-content", true)
              .append("g")
              .attr("transform", `translate(${margin.left},${margin.top})`);

            // Parse the data
            jsonData.forEach((d) => {
              d[xKey] = d[xKey];
              d[yKey] = +d[yKey];
            });

            // Filter data for only main locations
            const filteredData = jsonData.filter((d) =>
              mainLocations.includes(d[thirdKey])
            );

            // Group data by thirdKey (location)
            const groupedData = d3.group(filteredData, (d) => d[thirdKey]);

            // Scale functions
            const x = d3
              .scaleBand()
              .domain(jsonData.map((d) => d[xKey]))
              .range([0, width])
              .padding(0.1);

            const y = d3
              .scaleLinear()
              .domain([0, d3.max(filteredData, (d) => d[yKey])])
              .nice()
              .range([height, 0]);

            // Add the x-axis
            svg
              .append("g")
              .attr("transform", `translate(0,${height})`)
              .call(d3.axisBottom(x))
              .selectAll("text")
              .style("text-anchor", "end")
              .attr("transform", "rotate(-45)");

            // Add the y-axis
            svg.append("g").call(d3.axisLeft(y));

            // Add y-axis label
            svg
              .append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 0 - margin.left)
              .attr("x", 0 - height / 2)
              .attr("dy", "1em")
              .style("text-anchor", "middle")
              .attr("font-family", "Arial") // Adjust font family
              .attr("font-size", "14px") // Adjust font size
              .text(yLabel);

            // Add lines for each group
            const line = d3
              .line()
              .x((d) => x(d[xKey]) + x.bandwidth() / 2)
              .y((d) => y(d[yKey]));

            groupedData.forEach((groupData, location) => {
              svg
                .append("path")
                .datum(groupData)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", line);
            });
          }
        }, [jsonData, xKey, yKey, thirdKey, yLabel, mapType]);

        return <div id="lineGraph"></div>;
      }

      function BarChart({ jsonData, xKey, yKey, thirdKey, yLabel, mapType }) {
        React.useEffect(() => {
          if (jsonData) {
            logAndExtractUniqueValues({
              jsonData,
              xKey,
              yKey,
              thirdKey,
              yLabel,
              mapType,
            });
            // Create SVG container
            const svg = createSVG("barGraph");

            // Parse the data
            jsonData.forEach((d) => {
              d[xKey] = d[xKey];
              d[yKey] = +d[yKey];
            });

            // Scale functions
            const x = d3
              .scaleBand()
              .domain(jsonData.map((d) => d[xKey]))
              .range([0, width])
              .padding(0.1);

            const y = d3
              .scaleLinear()
              .domain([0, d3.max(jsonData, (d) => d[yKey])])
              .nice()
              .range([height, 0]);

            // Add the x-axis
            svg
              .append("g")
              .attr("transform", `translate(0,${height})`)
              .call(d3.axisBottom(x))
              .selectAll("text")
              .style("text-anchor", "end")
              .attr("transform", "rotate(-45)");

            // Add the y-axis
            svg.append("g").call(d3.axisLeft(y));

            // Add y-axis label
            svg
              .append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 0 - margin.left)
              .attr("x", 0 - height / 2)
              .attr("dy", "1em")
              .style("text-anchor", "middle")
              .attr("font-family", "Arial") // Adjust font family
              .attr("font-size", "14px") // Adjust font size
              .text(yLabel);

            // Add bars
            svg
              .selectAll(".bar")
              .data(jsonData)
              .enter()
              .append("rect")
              .attr("class", "bar")
              .attr("x", (d) => x(d[xKey]))
              .attr("width", x.bandwidth())
              .attr("y", (d) => y(d[yKey]))
              .attr("height", (d) => height - y(d[yKey]))
              .attr("fill", "steelblue");
          }
        }, [jsonData, xKey, yKey, thirdKey, yLabel, mapType]);

        return <div id="barGraph"></div>;
      }

      function GroupedBarChart({
        jsonData,
        xKey,
        yKey,
        thirdKey,
        yLabel,
        mapType,
      }) {
        React.useEffect(() => {
          if (jsonData) {
            // Log X Axis Values
            let xValues = [];
            if (xKey === "Unique Keys") {
              xValues = Object.keys(jsonData[0]).filter((key) =>
                key.endsWith("(%)")
              );
            } else {
              xValues = jsonData.map((item) => item[xKey]);
            }
            console.log("X Axis Values:", xValues);

            // Log Locations
            let locations = [];
            if (thirdKey === "AreaName") {
              // Get unique area names
              locations = [...new Set(jsonData.map((item) => item.AreaName))];
            } else if (thirdKey === "Unique Keys") {
              // Get location names from keys ending in "(%)"
              locations = Object.keys(jsonData[0])
                .filter((key) => key.endsWith("(%)"))
                .map((key) => key.split(" ")[0]);
            }
            console.log("Locations:", locations);

            // Log Values for each Location
            locations.forEach((location) => {
              const values = jsonData
                .filter(
                  (item) =>
                    item[thirdKey] ===
                    (thirdKey === "Unique Keys" ? `${location} (%)` : location)
                )
                .map((item) => item[`${location} (%)`]); // Access percentage values
              console.log(`${location}:`, values);
            });

            console.log("Y Key:", yKey);
            console.log("Third Key Variable:", thirdKey);
          }
        }, [jsonData, xKey, yKey, thirdKey, yLabel, mapType]);

        return (
          <div id="groupedBarGraph">{/* Bar graph will be drawn here */}</div>
        );
      }

      function SurveyChart({
        jsonData,
        xKey,
        yKey,
        thirdKey,
        yLabel,
        mapType,
      }) {
        const [questions, setQuestions] = React.useState([]);
        const [locations, setLocations] = React.useState([]);
        const [selectedQuestion, setSelectedQuestion] = React.useState("");
        const [selectedLocation, setSelectedLocation] = React.useState("");
        const [selectedResponseValues, setSelectedResponseValues] =
          React.useState([]);
        const [selectedResponses, setSelectedResponses] = React.useState([]);

        // Initialize data and log selected question, location, and responses
        React.useEffect(() => {
          const initializeData = () => {
            if (jsonData && jsonData.length > 0) {
              try {
                // Collect unique questions and locations
                const allQuestions = new Set();
                const allLocations = new Set();

                jsonData.forEach((item) => {
                  // Collect questions
                  allQuestions.add(item.Question);

                  // Collect locations
                  Object.keys(item).forEach((key) => {
                    if (
                      key !== "Response" &&
                      key !== "Percentage of respondents" &&
                      key !== "Question"
                    ) {
                      allLocations.add(key);
                    }
                  });
                });

                // Update state with unique questions and locations
                setQuestions([...allQuestions]);
                setLocations([...allLocations]);
                // Set default selected values
                setSelectedQuestion([...allQuestions][0]);
                setSelectedLocation([...allLocations][0]);
              } catch (error) {
                console.error("Error processing JSON data:", error);
              }
            } else {
              console.warn("No JSON data provided or empty array.");
            }
          };

          initializeData();
        }, [jsonData]);

        // Log selected question, location, and responses
        React.useEffect(() => {
          if (selectedQuestion) {
            console.log("Selected Question:", selectedQuestion);
          }
          if (selectedLocation) {
            console.log("Selected Location:", selectedLocation);
          }
          if (selectedResponseValues.length > 0) {
            console.log("Selected Response Values:", selectedResponseValues);
          }
          if (selectedResponses.length > 0) {
            console.log("Selected Responses:", selectedResponses);
          }
        }, [
          selectedQuestion,
          selectedLocation,
          selectedResponseValues,
          selectedResponses,
        ]);

        // Update selected responses and response values when selected question or location changes
        React.useEffect(() => {
          if (selectedQuestion && selectedLocation && jsonData) {
            const responses = jsonData
              .filter((item) => item.Question === selectedQuestion)
              .map((item) => item.Response);
            setSelectedResponses(responses);

            const responseValues = jsonData
              .filter((item) => item.Question === selectedQuestion)
              .map((item) => item[selectedLocation]);
            setSelectedResponseValues(responseValues);
          }
        }, [selectedQuestion, selectedLocation, jsonData]);

        // Draw Bar Chart
        const drawBarChart = () => {
          const data = selectedResponseValues.map((value, index) => ({
            x: selectedResponses[index],
            y: value,
          }));

          const containerId = "surveyGraph";
          const margin = { top: 20, right: 20, bottom: 150, left: 50 };
          const width = 600 - margin.left - margin.right;
          const height = 400 - margin.top - margin.bottom;

          // Remove previous SVG
          d3.select(`#${containerId} svg`).remove();

          // Create SVG container
          const svg = d3
            .select(`#${containerId}`)
            .append("svg")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr(
              "viewBox",
              `0 0 ${width + margin.left + margin.right} ${
                height + margin.top + margin.bottom
              }`
            )
            .classed("svg-content", true)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

          const x = d3
            .scaleBand()
            .domain(data.map((d) => d.x))
            .range([0, width])
            .padding(0.1);

          const y = d3
            .scaleLinear()
            .domain([0, d3.max(data, (d) => d.y)])
            .nice()
            .range([height, 0]);

          svg
            .append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("transform", "rotate(-45)");

          svg.append("g").call(d3.axisLeft(y));

          svg
            .selectAll("mybar")
            .data(data)
            .enter()
            .append("rect")
            .attr("x", (d) => x(d.x))
            .attr("y", (d) => y(d.y))
            .attr("width", x.bandwidth())
            .attr("height", (d) => height - y(d.y))
            .attr("fill", "steelblue");
        };

        // Call draw function when data is available
        React.useEffect(() => {
          if (
            selectedResponseValues.length > 0 &&
            selectedResponses.length > 0
          ) {
            drawBarChart();
          }
        }, [selectedResponseValues, selectedResponses]);

        return (
          <div>
            <div>
              <label htmlFor="questionSelect">Select a Question:</label>
              <select
                id="questionSelect"
                value={selectedQuestion}
                onChange={(e) => setSelectedQuestion(e.target.value)}
              >
                {questions.map((question, index) => (
                  <option key={index} value={question}>
                    {question}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label htmlFor="locationSelect">Select a Location:</label>
              <select
                id="locationSelect"
                value={selectedLocation}
                onChange={(e) => setSelectedLocation(e.target.value)}
              >
                {locations.map((location, index) => (
                  <option key={index} value={location}>
                    {location}
                  </option>
                ))}
              </select>
            </div>
            <div id="surveyGraph">{/* Bar chart will be drawn here */}</div>
          </div>
        );
      }

      function GridExample() {
        // Defining variables
        const [jsonData, setJsonData] = React.useState(null);
        const [pageCommentary, setPageCommentary] = React.useState("");
        const [tableCommentary, setTableCommentary] = React.useState("");
        const [chartType, setChartType] = React.useState(null);
        const [yLabel, setYLabel] = React.useState("");
        const [xKey, setXKey] = React.useState("");
        const [yKey, setYKey] = React.useState("");
        const [thirdKey, setThirdKey] = React.useState("");
        const [mapType, setMapType] = React.useState("");

        // Function to parse chart name from URL
        const parseChartNameFromURL = () => {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get("chart");
        };

        // Fetch JSON data
        React.useEffect(() => {
          const basePath = "/Python.JS Scripts/Clean Data/";
          const chartName = parseChartNameFromURL();
          const csvFilePath = "/Content/Chart-Visual-Database.csv";

          // Fetch and parse CSV data using Papa Parse
          Papa.parse(csvFilePath, {
            download: true,
            header: true,
            complete: (results) => {
              const chartRow = results.data.find(
                (row) => row["Visual-Chart-Name"] === chartName
              );
              if (chartRow) {
                const filePath = chartRow["File-Path"];
                const jsonDataFilePath = basePath + filePath;

                // Set Page Commentary and Table Commentary
                setPageCommentary(chartRow["Page Commentary"]);
                setTableCommentary(chartRow["Table Commentary"]);
                setChartType(chartRow["Chart-Type"]);
                setYLabel(chartRow["Y-Label"]);
                setXKey(chartRow["X-Axis-Key"]);
                setYKey(chartRow["Y-Axis-Key"]);
                setThirdKey(chartRow["Third-Var-Key"]);
                setMapType(chartRow["Map-Type"]);

                console.log("Chart Type:", chartRow["Chart-Type"]);

                // Fetch JSON data
                fetch(jsonDataFilePath)
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error("Network response was not ok");
                    }
                    return response.json();
                  })
                  .then((data) => {
                    console.log("JSON data fetched successfully:", data);
                    setJsonData(data);
                  })
                  .catch((error) => {
                    console.error("Error fetching JSON data:", error);
                  });
              } else {
                console.error("Chart not found in CSV:", chartName);
              }
            },
            error: (error) => {
              console.error("Error parsing CSV:", error);
            },
          });
        }, []);

        // Determine which chart component to render
        const getChartComponent = (chartType) => {
          switch (chartType) {
            case "line":
              return (
                <LineChart
                  jsonData={jsonData}
                  yLabel={yLabel}
                  xKey={xKey}
                  yKey={yKey}
                  thirdKey={thirdKey}
                  mapType={mapType}
                />
              );
            case "grouped-bar":
              return (
                <GroupedBarChart
                  jsonData={jsonData}
                  yLabel={yLabel}
                  xKey={xKey}
                  yKey={yKey}
                  thirdKey={thirdKey}
                  mapType={mapType}
                />
              );
            case "survey-bar":
              return (
                <SurveyChart
                  jsonData={jsonData}
                  yLabel={yLabel}
                  xKey={xKey}
                  yKey={yKey}
                  thirdKey={thirdKey}
                  mapType={mapType}
                />
              );
            case "bar":
              return (
                <BarChart
                  jsonData={jsonData}
                  yLabel={yLabel}
                  xKey={xKey}
                  yKey={yKey}
                  thirdKey={thirdKey}
                  mapType={mapType}
                />
              );
            default:
              return null;
          }
        };

        // Render content
        return (
          <div className="grid-container">
            <div
              className="grid-item grid-item-chart"
              style={{ gridColumn: "span 2", gridRow: "span 5" }}
            >
              {/* Render the appropriate chart component */}
              {getChartComponent(
                chartType,
                jsonData,
                xKey,
                yKey,
                thirdKey,
                yLabel,
                mapType
              )}
            </div>
            <div
              className="grid-item"
              style={{ gridColumn: "span 1", gridRow: "span 3" }}
            >
              <h2>Chart Info</h2>
              <p>{tableCommentary}</p>
            </div>
            <div
              className="grid-item"
              style={{ gridColumn: "span 1", gridRow: "span 2" }}
            >
              <h2>Chart Commentary</h2>
              <p>{pageCommentary}</p>
            </div>
          </div>
        );
      }

      // Render the GridExample component in the root div
      ReactDOM.render(<GridExample />, document.getElementById("root"));
    </script>

    <script src="/Scripts/chart-menu.js"></script>
    <script src="/Scripts/chart-data.js"></script>
  </body>
</html>
